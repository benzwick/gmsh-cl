name: test
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y sbcl \
            libfltk1.3-dev \
            libocct-modeling-algorithms-dev libocct-modeling-data-dev \
            libocct-data-exchange-dev libocct-foundation-dev \
            libgl-dev libglu1-mesa-dev

      - name: Install ocicl
        run: |
          OCICL_VERSION=2.16.5
          LATEST=$(curl -sL https://api.github.com/repos/ocicl/ocicl/releases/latest | grep -o '"tag_name": *"[^"]*"' | cut -d'"' -f4 | sed 's/^v//')
          if [ "$LATEST" != "$OCICL_VERSION" ]; then
            echo "::warning::ocicl $LATEST is available, update from $OCICL_VERSION"
          fi
          wget -q "https://github.com/ocicl/ocicl/releases/download/v${OCICL_VERSION}/ocicl_${OCICL_VERSION}-1_amd64.deb"
          sudo apt install -y ./ocicl_${OCICL_VERSION}-1_amd64.deb
          ocicl setup
          ocicl install

      - name: Cache libgmsh build
        uses: actions/cache@v4
        with:
          path: _reference/gmsh/build
          key: libgmsh-${{ hashFiles('.gitmodules') }}

      - name: Build libgmsh
        run: |
          cd _reference/gmsh
          mkdir -p build && cd build
          cmake .. -DENABLE_BUILD_SHARED=ON -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc)

      - name: Run tests
        run: ./run-tests.sh
